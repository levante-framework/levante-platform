{"version":3,"file":"AuthEmailLink-Dz42O4jl.js","sources":["../../src/components/auth/AuthEmailLink.vue"],"sourcesContent":["<template>\n  <LevanteSpinner v-if=\"!isError\" fullscreen />\n  <div v-else style=\"margin-top: 200px\">\n    <i class=\"pi pi-exclamation-circle text-6xl text-red-500 center\"></i>\n    <p class=\"text-xl font-semibold text-center\">There was a problem with the email sign-in link. Please try again.</p>\n    <div class=\"center\">\n      <PvButton label=\"Back to sign in\" @click=\"router.push({ name: 'SignIn' })\" />\n    </div>\n  </div>\n</template>\n\n<script setup>\nimport { onMounted, ref } from 'vue';\nimport { useRouter } from 'vue-router';\nimport { storeToRefs } from 'pinia';\nimport PvButton from 'primevue/button';\nimport { useAuthStore } from '@/store/auth';\nimport { fetchDocById } from '@/helpers/query/utils';\nimport LevanteSpinner from '@/components/LevanteSpinner.vue';\nimport { logger } from '@/logger';\n\nconst router = useRouter();\nconst authStore = useAuthStore();\nconst { roarfirekit, uid } = storeToRefs(authStore);\nconst isError = ref(false);\n\nconst loginFromEmailLink = async (email) => {\n  unsubscribe();\n  const emailLink = window.location.href;\n  await authStore\n    .signInWithEmailLink({ email, emailLink })\n    .then(async () => {\n      if (uid) {\n        // Not sure why we need this since user data and claims are fetched in the HomeSelector.vue but otherwise won't load homepage.\n        // TODO: Remove once we figure out why the homepage doesn't load without this.\n        const userData = await fetchDocById('users', uid.value);\n        const userClaims = await fetchDocById('userClaims', uid.value);\n\n        authStore.setUserData(userData);\n        authStore.setUserClaims(userClaims);\n        router.push({ name: 'Home' });\n      }\n    })\n    .catch((error) => {\n      isError.value = true;\n      console.error('error logging in:', error);\n    });\n};\n\n// The user is on the email link authentication page (AuthEmailLink.vue), but:\n// The necessary email is missing from local storage (so the primary sign-in logic via loginFromEmailLink cannot proceed).\n// AND roarfirekit indicates it's expecting an email link sign-in process to be underway.\n// AND the current page's URL is not a valid email sign-in link (e.g., the token in the URL is missing, invalid, or expired, or the user navigated to the path without a token).\nconst unsubscribe = authStore.$subscribe(async (mutation, state) => {\n  if (state.roarfirekit.isSignInWithEmailLink && state.roarfirekit.signInWithEmailLink) {\n    if (!roarfirekit.value.isSignInWithEmailLink(window.location.href)) {\n      router.replace({ name: 'Home' });\n    }\n  }\n});\n\nonMounted(async () => {\n  const email = window.localStorage.getItem('emailForSignIn');\n  if (email) {\n    try {\n      await loginFromEmailLink(email);\n    } catch (error) {\n      console.error('error logging in:', error);\n      logger.capture('Error logging in with email link', { error });\n      isError.value = true;\n    }\n  } else {\n    // No email in localStorage, so we need to show a message\n    isError.value = true;\n    logger.capture('No email in localStorage');\n  }\n});\n</script>\n\n<style scoped>\n.center {\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  margin-top: 30px;\n}\n</style>\n"],"names":["router","useRouter","authStore","useAuthStore","roarfirekit","uid","storeToRefs","isError","ref","loginFromEmailLink","email","unsubscribe","emailLink","userData","fetchDocById","userClaims","error","mutation","state","onMounted","logger","_openBlock","_createElementBlock","_hoisted_1","_createElementVNode","_cache","_hoisted_2","_createVNode","_unref","PvButton","$event","_createBlock","LevanteSpinner"],"mappings":"0sBAqBA,MAAMA,EAASC,EAAS,EAClBC,EAAYC,EAAY,EACxB,CAAE,YAAAC,EAAa,IAAAC,GAAQC,EAAYJ,CAAS,EAC5CK,EAAUC,EAAI,EAAK,EAEnBC,EAAqB,MAAOC,GAAU,CAC1CC,EAAW,EACX,MAAMC,EAAY,OAAO,SAAS,KAClC,MAAMV,EACH,oBAAoB,CAAE,MAAAQ,EAAO,UAAAE,CAAS,CAAE,EACxC,KAAK,SAAY,CAChB,GAAIP,EAAK,CAGP,MAAMQ,EAAW,MAAMC,EAAa,QAAST,EAAI,KAAK,EAChDU,EAAa,MAAMD,EAAa,aAAcT,EAAI,KAAK,EAE7DH,EAAU,YAAYW,CAAQ,EAC9BX,EAAU,cAAca,CAAU,EAClCf,EAAO,KAAK,CAAE,KAAM,MAAM,CAAE,CAC9B,CACF,CAAC,EACA,MAAOgB,GAAU,CAChBT,EAAQ,MAAQ,GAChB,QAAQ,MAAM,oBAAqBS,CAAK,CAC1C,CAAC,CACL,EAMML,EAAcT,EAAU,WAAW,MAAOe,EAAUC,IAAU,CAC9DA,EAAM,YAAY,uBAAyBA,EAAM,YAAY,sBAC1Dd,EAAY,MAAM,sBAAsB,OAAO,SAAS,IAAI,GAC/DJ,EAAO,QAAQ,CAAE,KAAM,MAAM,CAAE,EAGrC,CAAC,EAED,OAAAmB,EAAU,SAAY,CACpB,MAAMT,EAAQ,OAAO,aAAa,QAAQ,gBAAgB,EAC1D,GAAIA,EACF,GAAI,CACF,MAAMD,EAAmBC,CAAK,CAChC,OAASM,EAAO,CACd,QAAQ,MAAM,oBAAqBA,CAAK,EACxCI,EAAO,QAAQ,mCAAoC,CAAE,MAAAJ,CAAK,CAAE,EAC5DT,EAAQ,MAAQ,EAClB,MAGAA,EAAQ,MAAQ,GAChBa,EAAO,QAAQ,0BAA0B,CAE7C,CAAC,SA3EwBb,EAAA,OACvBc,IAAAC,EAMM,MANNC,EAMM,aALJC,EAAqE,IAAA,CAAlE,MAAM,uDAAuD,EAAA,KAAA,EAAA,GAChEC,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAD,EAAmH,IAAA,CAAhH,MAAM,mCAAmC,EAAC,qEAAkE,EAAA,GAC/GA,EAEM,MAFNE,EAEM,CADJC,EAA6EC,EAAAC,CAAA,EAAA,CAAnE,MAAM,kBAAmB,QAAKJ,EAAA,CAAA,IAAAA,EAAA,CAAA,EAAAK,GAAEF,EAAA5B,CAAA,EAAO,KAAI,CAAA,KAAA,QAAA,CAAA,eALzD+B,EAA6CC,EAAA,OAAb,WAAA"}