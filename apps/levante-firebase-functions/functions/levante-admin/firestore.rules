rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ============ CORE AUTH FUNCTIONS ============
    // Basic authentication check
    function loggedIn() {
      return request.auth != null;
    }

    // Get the user ID from the auth token
    function getUid() {
      return request.auth.uid;
    }

    // Check if user should use new permission system
    function shouldUseNewPermissions() {
      return request.auth != null &&
             request.auth.token.get('useNewPermissions', false) == true;
    }

    // ============ LEGACY SYSTEM (from userClaims document) ============
    // Fetch user claims from the userClaims collection
    function getUserClaims() {
      return get(/databases/$(database)/documents/userClaims/$(request.auth.uid)).data.get("claims", {});
    }

    // Legacy: Check if user is a super_admin or admin
    function isSuperAdminOrAdminLegacy() {
      let claims = getUserClaims();
      return claims.get("super_admin", false) || claims.get("admin", false);
    }

    // Legacy: Get admin orgs from userClaims
    function getAdminOrgs() {
      return getUserClaims().get('adminOrgs', {});
    }

    // Legacy: Check if user is admin for specific org IDs
    function isAdminForOrgType(orgType, orgIds) {
      return orgIds.size() > 0 && getAdminOrgs().get(orgType, []).hasAny(orgIds);
    }

    // Legacy: Check if user is admin for any organization
    function isAdminForAnyOrgType(orgData) {
      return isAdminForOrgType('districts', orgData.get('districts', []))
        || isAdminForOrgType('schools', orgData.get('schools', []))
        || isAdminForOrgType('classes', orgData.get('classes', []))
        || isAdminForOrgType('groups', orgData.get('groups', []))
    }

    // ============ NEW PERMISSION SYSTEM (from auth token) ============
    // Get user's roles from auth token
    function getUserRolesFromAuth() {
      return request.auth.token.get('roles', []);
    }

    // Get the system permissions document
    function getSystemPermissions() {
      return get(/databases/$(database)/documents/system/permissions).data.get('permissions', {});
    }

    // New: Check if user has a specific role
    function hasRole(role) {
      let roles = getUserRolesFromAuth();
      return roles.hasAny([role]);
    }

    // New: Get the highest role for a user
    function getHighestRole() {
      let roles = getUserRolesFromAuth();
      return roles.size() == 0 ? 'participant' :
             roles.hasAny(['super_admin']) ? 'super_admin' :
             roles.hasAny(['site_admin']) ? 'site_admin' :
             roles.hasAny(['admin']) ? 'admin' :
             roles.hasAny(['research_assistant']) ? 'research_assistant' : 'participant';
    }

    // New: Check if user has permission for a specific action
    function hasPermission(resource, action) {
      let highestRole = getHighestRole();
      let permissions = getSystemPermissions();
      let rolePerms = permissions.get(highestRole, {});
      let resourcePerms = rolePerms.get(resource, []);

      return resourcePerms.hasAny([action]);
    }

    // New: Check if user is super_admin or site_admin
    function isSuperAdminOrAdminNew() {
      return hasRole('super_admin') || hasRole('site_admin');
    }

    // ============ UNIFIED PERMISSION CHECK ============
    // Main function that routes to new or legacy system based on flag
    function isSuperAdminOrAdmin() {
      return shouldUseNewPermissions() ?
        isSuperAdminOrAdminNew() :
        isSuperAdminOrAdminLegacy();
    }

    // Super admins and admins can access everything
    match /{document=**} {
      allow read, write: if isSuperAdminOrAdmin();
    }

    // ============ KEY VALIDATION FUNCTIONS ============
    function keysNotUpdated(keys) {
      return !request.resource.data.diff(resource.data).affectedKeys().hasAny(keys);
    }

    function onlyTheseKeysUpdated(keys) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(keys);
    }

    // ============ USER CLAIMS ============
    match /userClaims/{uid} {
      allow read: if loggedIn() && uid == request.auth.uid;
      allow write: if false;
    }

    // ============ SYSTEM PERMISSIONS ============
    match /system/permissions {
      allow read: if loggedIn();
      allow write: if false;
    }

    // ============ LEGAL DOCS ============
    match /legal/{form} {
      allow read: if true;
      allow write: if false;
    }

    // ============ USERS COLLECTION ============
    match /users/{uid} {
      function myData() {
        return uid == request.auth.uid;
      }

      function isParentOfUser() {
        let parentUser = get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
        return parentUser.userType == 'parent' && resource.data.parentIds.hasAny([request.auth.uid]);
      }

      function isUserAdmin() {
        return isAdminForAnyOrgType({
          'districts': resource.data.get(['districts', 'current'], []),
          'schools': resource.data.get(['schools', 'current'], []),
          'classes': resource.data.get(['classes', 'current'], []),
          'groups': resource.data.get(['groups', 'current'], [])
        });
      }

      // Unified read permission check
      function canReadUser() {
        return shouldUseNewPermissions() ?
          ((myData() || isParentOfUser()) || (hasPermission('users', 'read') && isUserAdmin())) :
          (myData() || isUserAdmin() || isParentOfUser());
      }

      allow read: if canReadUser();

      function hasValidOrgStructure() {
        let data = request.resource.data;
        return data.get(['districts', 'current'], []).size() <= 1
          && data.get(['schools', 'current'], []).size() <= 1;
      }

      function isValidAdminAction(orgType, allowedKeys) {
        return isAdminForOrgType(orgType, request.resource.data.get([orgType, 'current'], []))
          && request.resource.data.keys().hasOnly(allowedKeys);
      }

      // Unified create permission check
      function canCreateUser() {
        let baseCheck = loggedIn() && hasValidOrgStructure() && (
          isValidAdminAction('districts', ['userType', 'name', 'assessmentPid', 'studentData', 'educatorData', 'caregiverData', 'adminData',
'districts', 'schools', 'classes', 'assessmentUid'])
          || isValidAdminAction('schools', ['userType', 'name', 'assessmentPid', 'studentData', 'educatorData', 'caregiverData', 'adminData',
'districts', 'schools', 'classes', 'assessmentUid'])
          || isValidAdminAction('classes', ['userType', 'name', 'assessmentPid', 'studentData', 'educatorData', 'caregiverData', 'adminData',
'districts', 'schools', 'classes', 'assessmentUid'])
          || isValidAdminAction('groups', ['userType', 'name', 'assessmentPid', 'studentData', 'educatorData', 'caregiverData', 'adminData',
'groups', 'assessmentUid'])
        );

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('users', 'create')) :
          baseCheck;
      }

      allow create: if canCreateUser();

      // Unified update permission check
      function canUpdateUser() {
        let baseCheck = (myData() || isUserAdmin()) && keysNotUpdated(['archived', 'assessmentUid']);

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('users', 'update')) :
          baseCheck;
      }

      allow update: if canUpdateUser();

      // Unified delete permission check
      function canDeleteUser() {
        return shouldUseNewPermissions() ?
          hasPermission('users', 'delete') :
          false;
      }

      allow delete: if canDeleteUser();

      // Survey responses
      match /surveyResponses/{responseId} {
        allow read, write: if myData();
      }

      // External data
      match /externalData/{externalDataId} {
        allow read: if loggedIn() && (myData() || isUserAdmin());
        allow write: if false;
      }

      // Assignments
      match /assignments/{administrationId} {
        function canReadAssignment() {
          let baseCheck = loggedIn() && (myData() || isAdminForAnyOrgType(resource.data.get('assigningOrgs', {})));

          return shouldUseNewPermissions() ?
            (baseCheck && hasPermission('assignments', 'read')) :
            baseCheck;
        }

        function canUpdateAssignment() {
          let baseCheck = myData() && keysNotUpdated(['assigningOrgs'])
            && request.resource.data.get('assessments', []).size() == resource.data.get('assessments', []).size();

          return shouldUseNewPermissions() ?
            (baseCheck && hasPermission('assignments', 'update')) :
            baseCheck;
        }

        allow read: if canReadAssignment();
        allow create: if false;
        allow update: if canUpdateAssignment();
      }

      // Runs
      match /runs/{runId} {
        function canReadRun() {
          return loggedIn() && (myData()
            || isAdminForAnyOrgType(resource.data.get('assigningOrgs', {}))
            || isAdminForAnyOrgType(resource.data.get('readOrgs', {})));
        }

        allow read: if canReadRun();
        allow create: if myData();
        allow update: if myData();

        match /trials/{trialId} {
          function canReadTrial() {
            let runData = get(/databases/$(database)/documents/users/$(uid)/runs/$(runId)).data;
            return loggedIn() && (myData()
              || isAdminForAnyOrgType(runData.get('assigningOrgs', {}))
              || isAdminForAnyOrgType(runData.get('readOrgs', {})));
          }

          allow read: if canReadTrial();
          allow write: if myData();
        }
      }
    }

    // ============ GROUP ASSIGNMENTS ============
    match /{path=**}/assignments/{assignmentId} {
      function canReadGroupAssignment() {
        let baseCheck = loggedIn() && isAdminForAnyOrgType(resource.data.get('assigningOrgs', {}));

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('assignments', 'read')) :
          baseCheck;
      }

      allow read: if canReadGroupAssignment();
    }

    // ============ ADMINISTRATIONS ============
    match /administrations/{administrationId} {
      function userAssignedToAdministration() {
        let userData = get(/databases/$(database)/documents/users/$(getUid())).data;
        return userData.get(['districts', 'current'], []).hasAny(resource.data.districts)
          || userData.get(['schools', 'current'], []).hasAny(resource.data.schools)
          || userData.get(['classes', 'current'], []).hasAny(resource.data.classes)
          || userData.get(['groups', 'current'], []).hasAny(resource.data.groups)
      }

      function userCreatedAdministration() {
        return getUid() == resource.data.get('createdBy', 'nullId');
      }

      function canReadAdministration() {
        let baseCheck = loggedIn() && (userAssignedToAdministration() || userCreatedAdministration() || isAdminForAnyOrgType(resource.data));

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('admins', 'read')) :
          baseCheck;
      }

      function canCreateAdministration() {
        let baseCheck = loggedIn() && getUid() == request.resource.data.createdBy && isAdminForAnyOrgType(request.resource.data);

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('admins', 'create')) :
          baseCheck;
      }

      function canUpdateAdministration() {
        let baseCheck = loggedIn() && (userCreatedAdministration() || isAdminForAnyOrgType(resource.data)) && keysNotUpdated(['createdBy']);

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('admins', 'update')) :
          baseCheck;
      }

      function canDeleteAdministration() {
        return shouldUseNewPermissions() ?
          hasPermission('admins', 'delete') :
          false;
      }

      allow read: if canReadAdministration();
      allow create: if canCreateAdministration();
      allow update: if canUpdateAdministration();
      allow delete: if canDeleteAdministration();

      match /stats/completion {
        allow read: if loggedIn() && (userCreatedAdministration() ||
          isAdminForAnyOrgType(get(/databases/$(database)/documents/administrations/$(administrationId)).data));
        allow write: if false;
      }
    }

    // ============ ORG COLLECTIONS ============
    function getUserOrgs(orgType) {
      return get(/databases/$(database)/documents/users/$(getUid())).data.get([orgType, 'current'], []);
    }

    // Districts
    match /districts/{districtId} {
      allow read: if loggedIn() && (districtId in getUserOrgs('districts') || isAdminForOrgType('districts', [districtId]));
      allow write: if false;
    }

    // Schools
    match /schools/{schoolId} {
      allow read: if schoolId in getUserOrgs('schools') || isAdminForOrgType('schools', [schoolId]) ||
        isAdminForOrgType('districts', [resource.data.get('districtId', 'nullId')]);
      allow create: if isAdminForOrgType('districts', [request.resource.data.get('districtId', 'nullId')]);
      allow update, delete: if isAdminForOrgType('districts', [resource.data.get('districtId', 'nullId')]);
    }

    // Classes
    match /classes/{classId} {
      allow read: if classId in getUserOrgs('classes') || isAdminForOrgType('classes', [classId])
        || isAdminForOrgType('schools', [resource.data.get('schoolId', 'nullId')])
        || isAdminForOrgType('districts', [resource.data.get('districtId', 'nullId')]);
      allow create: if isAdminForOrgType('districts', [request.resource.data.get('districtId', 'nullId')])
        || isAdminForOrgType('schools', [request.resource.data.get('schoolId', 'nullId')]);
      allow update, delete: if isAdminForOrgType('districts', [resource.data.get('districtId', 'nullId')])
        || isAdminForOrgType('schools', [resource.data.get('schoolId', 'nullId')]);
    }

    // Groups
    match /groups/{groupId} {
      function canReadGroup() {
        let baseCheck = loggedIn() && (groupId in getUserOrgs('groups') || isAdminForOrgType('groups', [groupId]));

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('groups', 'read')) :
          baseCheck;
      }

      function canWriteGroup(action) {
        let baseCheck = isAdminForOrgType('groups', [groupId]);

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('groups', action)) :
          baseCheck;
      }

      allow read: if canReadGroup();
      allow create: if canWriteGroup('create');
      allow update: if canWriteGroup('update');
      allow delete: if canWriteGroup('delete');
    }

    // ============ GUESTS ============
    match /guests/{guestUid} {
      function isGuest() {
        return loggedIn() && request.auth.uid == guestUid;
      }

      allow read: if isGuest();
      allow create: if isGuest() && request.resource.data.get('userType', 'nullType') == 'guest';
      allow update: if isGuest() && keysNotUpdated(['userType']);
      allow delete: if false;

      match /runs/{runId} {
        allow read: if false;
        allow create, update: if isGuest();
        allow delete: if false;

        match /trials/{trialId} {
          allow read: if false;
          allow create, update: if isGuest();
          allow delete: if false;
        }
      }
    }

    // ============ TASKS ============
    match /tasks/{taskId} {
      function canUpdateTask() {
        let newParams = request.resource.data.get("params", {});
        let oldParams = resource.data.get("params", {});
        return loggedIn()
          && keysNotUpdated(['registered'])
          && onlyTheseKeysUpdated(['description', 'lastUpdated', 'params', "createdAt", "updatedAt"])
          && newParams.diff(oldParams).addedKeys().size() == 0
          && newParams.diff(oldParams).removedKeys().size() == 0;
      }

      function canReadTask() {
        return shouldUseNewPermissions() ?
          (loggedIn() && hasPermission('tasks', 'read')) :
          loggedIn();
      }

      function canCreateTask() {
        let baseCheck = loggedIn() && !request.resource.data.keys().hasAny(['registered']);

        return shouldUseNewPermissions() ?
          (baseCheck && hasPermission('tasks', 'create')) :
          baseCheck;
      }

      function canUpdateTaskWithPermission() {
        return shouldUseNewPermissions() ?
          (canUpdateTask() && hasPermission('tasks', 'update')) :
          canUpdateTask();
      }

      function canDeleteTask() {
        return shouldUseNewPermissions() ?
          hasPermission('tasks', 'delete') :
          false;
      }

      allow read: if canReadTask();
      allow create: if canCreateTask();
      allow update: if canUpdateTaskWithPermission();
      allow delete: if canDeleteTask();

      match /variants/{variantId} {
        allow read: if canReadTask();
        allow create: if canCreateTask();
        allow update: if canUpdateTaskWithPermission();
        allow delete: if canDeleteTask();
      }
    }
  }
}
